<launch>
  <arg name="nav" default="true" />
  <arg name="rosbag_play" default="true" />
  <arg name="bag" default="/media/Edog/Rosbag/dpo.bag"/>
  <arg name="saved_map" default="$(env ROS_TEST_RESULTS_DIR)/map.yaml"/>

  <group if="$(arg rosbag_play)">
    <!-- Plays the rosbag file -->
    <node pkg="rosbag" type="play" name="rosbag" args="$(arg bag) --clock" />
    <param name="use_sim_time" type="bool" value="True"/> 

    <!-- Creates a pointcloud from depth and rgbd images -->
    <node pkg="nodelet" type="nodelet" args="manager"
      name="record_player_manager" output="screen"/>
      <node pkg="nodelet" type="nodelet" name="cloudify"
        args="load depth_image_proc/point_cloud_xyzrgb record_player_manager --no-bond">
        <remap from="depth_registered/image_rect" to="/camera/depth_registered/hw_registered/image_rect_raw_throttle"/>
        <remap from="depth_registered/points" to="camera/depth_registered/points"/>
        <remap from="rgb/image_rect_color" to="/camera/rgb/image_rect_color_throttle"/>
        <remap from="rgb/camera_info" to="/camera/depth/camera_info"/>
      </node>
    </group>

    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find qbo_rgbd_slam)/launch/graph_slam.rviz" />

    <!-- Start the mapping nodes -->
    <include file="$(find qbo_rgbd_slam)/launch/include/mapping.launch">
      <arg name="localization_only" value="true"/>
    </include>

    <!-- Publishes tf between map and odom frame"-->
    <node name="correction_pub" pkg="qbo_rgbd_slam" type="qbo_map_odom_publisher" />

    <!-- Add a voxel filter for the point cloud-->
    <node name="voxel_filter" pkg="qbo_pcl" type="qbo_pcl_decimator">
      <param name="leaf_size" value="0.1" />
      <param name="input_topic" value="/camera/depth_registered/points" />
      <param name="output_topic" value="/camera/depth_registered/points_filtered" />
    </node>

    <group if="$(arg nav)">
      <!--Map Server-->
      <node name="map_server_node" pkg="map_server" type="map_server" args="$(arg saved_map)" />
      <!--Path Planner-->
      <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
        <param name="planner_frequency" value="1.0" />
        <rosparam file="$(find qbo_rgbd_slam)/config/costmap_common_params.yaml" command="load" ns="global_costmap" />
        <rosparam file="$(find qbo_rgbd_slam)/config/costmap_common_params.yaml" command="load" ns="local_costmap" />
        <rosparam file="$(find qbo_rgbd_slam)/config/local_costmap_params.yaml" command="load" />
        <rosparam file="$(find qbo_rgbd_slam)/config/global_costmap_params.yaml" command="load" />
        <rosparam file="$(find qbo_rgbd_slam)/config/base_local_planner_params.yaml" command="load" />
      </node>
    </group>

  </launch>