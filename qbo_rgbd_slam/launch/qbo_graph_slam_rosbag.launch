<launch>
  <arg name="nav" default="false" />
  <arg name="bag" default="/media/Edog/Rosbag/dpo.bag"/>
  <arg name="2d_map_gen" default="false"/>
  <node pkg="rosbag" type="play" name="rosbag" args="$(arg bag) --clock" />
  <param name="use_sim_time" type="bool" value="True"/>
 

  <node name="rviz" pkg="rviz" type="rviz" args="-d $(find qbo_rgbd_slam)/launch/graph_slam.rviz" />
  
  <!-- Start the mapping nodes -->
  <include file="$(find qbo_rgbd_slam)/launch/include/mapping.launch">
    <arg name="rgb_input_topic" value="/camera/rgb/image_rect_color_throttle" />
    <arg name="depth_input_topic" value="/camera/depth_registered/hw_registered/image_rect_raw_throttle" />
  </include>

  <node name="correction_pub" pkg="qbo_rgbd_slam" type="qbo_map_odom_publisher" />

  	<node pkg="nodelet" type="nodelet" args="manager"
        name="record_player_manager" output="screen"/>

  	<node pkg="nodelet" type="nodelet" name="cloudify"
        args="load depth_image_proc/point_cloud_xyzrgb record_player_manager --no-bond">
    	<remap from="depth_registered/image_rect" to="/camera/depth_registered/hw_registered/image_rect_raw_throttle"/>
    	<remap from="depth_registered/points" to="camera/depth_registered/points"/>
    	<remap from="rgb/image_rect_color" to="/camera/rgb/image_rect_color_throttle"/>
    	<remap from="rgb/camera_info" to="/camera/depth/camera_info"/>
	</node>

      <!-- Add a voxel filter for the point cloud-->
    <node name="voxel_filter" pkg="qbo_pcl" type="qbo_pcl_decimator">
      <param name="leaf_size" value="0.1" />
      <param name="input_topic" value="/camera/depth_registered/points" />
      <param name="output_topic" value="/camera/depth_registered/points_filtered" />
    </node>

  <group if="$(arg 2d_map_gen)">
     <node pkg="octomap_server" type="octomap_server_node" name="octomap_server">
      <param name="resolution" value="0.1" />	
      <!-- fixed map frame (set to 'map' if SLAM or localization running!) -->
      <param name="frame_id" type="string" value="/map" />
      <param name="latch" value="false" />
      <!-- maximum range to integrate (speedup!) -->
      <param name="filter_ground" value="false" />
      <param name="occupancy_max_z" value="0.6" />
      <param name="occupancy_min_z" value="0.05" />
      <param name="ground_filter/plane_distance=" value="0.0" />
      <param name="sensor_model/min" value="0.12" />
      <param name="sensor_model/max" value="0.97" />
      <param name="sensor_model/hit" value="0.7" />
      <param name="sensor_model/miss" value="0.4" />
      <param name="sensor_model/max_range" value="7" />
    </node>
  </group>

  <group if="$(arg nav)">
	<node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
      <param name="planner_frequency" value="1.0" />
      <rosparam file="$(find qbo_rgbd_slam)/config/costmap_common_params.yaml" command="load" ns="global_costmap" />
      <rosparam file="$(find qbo_rgbd_slam)/config/costmap_common_params.yaml" command="load" ns="local_costmap" />
      <rosparam file="$(find qbo_rgbd_slam)/config/local_costmap_params.yaml" command="load" />
      <rosparam file="$(find qbo_rgbd_slam)/config/global_costmap_params.yaml" command="load" />
      <rosparam file="$(find qbo_rgbd_slam)/config/base_local_planner_params.yaml" command="load" />
    </node>
  </group>
</launch>
